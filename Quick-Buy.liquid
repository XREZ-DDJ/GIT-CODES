{%- capture product_form_id -%}product-form-quick-buy-{{ product.id }}-{{ section.id }}{%- endcapture -%}

<template id="quick-buy-content">
  <p class="h5" slot="header">{{ 'product.general.choose_options' | t }}</p>
  <div class="quick-buy-modal__content">
    <product-rerender id="quick-buy-modal-content" observe-form="{{ product_form_id }}" data-loaded="true">
      <script>
        document.addEventListener("DOMContentLoaded", function() {
          setTimeout(() => {
            let quickBuyModal = document.getElementById("quick-buy-modal-content");
            if (quickBuyModal) {
              quickBuyModal.setAttribute("data-loaded", "true");
            }
          }, 500);
        });
      </script>
      <dialog-close-button class="contents">
        <button type="button" class="quick-buy-modal__close-button sm-max:hidden">
          <span class="sr-only">{{ 'general.accessibility.close' | t }}</span>
          {%- render 'icon' with 'close' -%}
        </button>
      </dialog-close-button>
      
      <div class="quick-buy-modal__gallery-wrapper">
        {%- if product.media.size > 0 -%}
          {%- render 'product-gallery',
              product: product,
              product_form_id: product_form_id,
              desktop_layout: 'carousel_dots',
              mobile_controls: 'arrows',
              enable_media_autoplay: section.settings.enable_media_autoplay,
              enable_video_looping: section.settings.enable_video_looping,
              enable_image_zoom: false
          -%}
        {%- endif -%}

      </div>
      
      <div class="quick-buy-modal__info-wrapper">
        <div class="debug-info-custom">
          <a href="{{ product.url }}" class="product-title h4">{{ product.title }}</a>
  {%- if product.selected_or_first_available_variant != nil -%}
    <div class="price-large">
      {% render 'price-list', product: product, variant: product.selected_or_first_available_variant, hide_unit_price: true, context: 'card' %}
    </div>
  {%- endif -%}
          {%- render 'Product-Info-Beta', product: product, product_form_id: product_form_id, context: 'quick_buy' -%}
        </div>
        <a href="{{ product.url }}" class="quick-buy-modal__view-more link sm-max:hidden">{{ 'product.general.view_details' | t }}</a>
      </div>
    </product-rerender>
  </div>
  
  <!-- SCRIPT EXTRA: Lógica para plus/minus y agregar al carrito (múltiples variantes) -->
  <script>
    console.log("Quick Buy: Script extra cargado.");
    
    function initQuickBuyExtraLogic() {
      try {
        console.log("Quick Buy: Iniciando lógica extra...");
        
        // Selecciona los botones de incremento/decremento y el botón de agregar
        const qtyButtons = document.querySelectorAll('#quick-buy-modal-content .qty-btn');
        const addCartBtn = document.getElementById("add-to-cart-btn");
        
        if (!qtyButtons.length) {
          console.warn("Quick Buy: No se encontraron botones qty-btn.");
        }
        if (!addCartBtn) {
          console.warn("Quick Buy: No se encontró el botón #add-to-cart-btn.");
        }
        
        function updateCartState() {
          let total = 0;
          document.querySelectorAll('#quick-buy-modal-content .size-option')
